#!/bin/bash

function die {
  echo $@
  echo "ABORTED"
  exit 1
}

cmdline="$0 $@"
shift
report=gen_report_variants.txt
aliasreport=gen_report_aliases.txt
OPTIONS="--callstringlength=42 --alias-statistics=tmp_alias_statistics $@"

# --
nnh99=build/nnh99/nnh99
srw98=build/srw98/srw98

tab='\t'

function run_testcase {
  testcase="$1"

  echo "${testcase}" >> $report
  echo -e \
    "                                                                                 "\
    "${tab}nnh/may${tab}nnh/must${tab}srw/may${tab}srw/must" >> $report

  for var in \
    '--var-alias-from-graphset --var-keep-tempvars --var-aliases-common-tail          ' \
    '--var-alias-from-graphset --var-keep-tempvars --var-aliases-no-common-tail       ' \
    '--var-alias-from-graphset --var-delete-tempvars --var-aliases-common-tail        ' \
    '--var-alias-from-graphset --var-delete-tempvars --var-aliases-no-common-tail     ' \
    '--var-alias-from-summary-graph --var-keep-tempvars --var-aliases-common-tail     ' \
    '--var-alias-from-summary-graph --var-keep-tempvars --var-aliases-no-common-tail  ' \
    '--var-alias-from-summary-graph --var-delete-tempvars --var-aliases-common-tail   ' \
    '--var-alias-from-summary-graph --var-delete-tempvars --var-aliases-no-common-tail' \
  ; do
    echo -n "$var" >> $report
    run_variant "$nnh99" "$testcase" "$var"
    run_variant "$srw98" "$testcase" "$var"
    echo -e "${tab}${cmd}" >> $report
  done
  echo >> $report
  echo >> $report
}

function run_variant {
  binary="$1"
  testcase="$2"
  var="$3"

  cmd="$binary $OPTIONS $var $testcase"
  echo $cmd
  echo "$binary $testcase $var" >> $aliasreport
  time $cmd --output-alias-text | \
    grep -v 'writing alias statistics to tmp_alias_statistics' | \
    grep -v '^main: // pre ' | \
    tail -n 20 >> $aliasreport
  rc=$?
  echo >> $aliasreport
  echo >> $aliasreport
  echo >> $aliasreport
  echo

  # put in default values
  error_value='-'

  may_alias="$error_value"
  must_alias="$error_value"

  if [ $rc -eq 0 ]; then
    # analysis suceeded, 
    may_alias=`cat tmp_alias_statistics | awk "/sum\(post may_alias\):/ {print \\$3}"`
    must_alias=`cat tmp_alias_statistics | awk "/sum\(post must_alias\):/ {print \\$3}"`
  fi

  echo -ne "${tab}${may_alias}${tab}${must_alias}" >> $report
}

# write comment to $report
echo "# generated by $cmdline" > $report
echo -n "# started at " >> $report
date >> $report
echo '#' >> $report

# write comment to $report
echo "# generated by $cmdline" > $aliasreport
echo -n "# started at " >> $aliasreport
date >> $aliasreport
echo '#' >> $aliasreport


# write data rows to $report
find tests/variants -type f -name \*.C | sort | while IFS= read -r testcase; do
  run_testcase "$testcase"
done

# write final comment to $report
echo '#' >> $report
echo -n "# finished at " >> $report
date >> $report
echo '# vim'':'' ts=14 nowrap'':' >> $report

